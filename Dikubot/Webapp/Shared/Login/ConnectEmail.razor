@using global::Discord.WebSocket
@using Dikubot.Discord.Command
@using Dikubot.DataLayer.Database.Global.Session
@using Dikubot.DataLayer.Database.Global.User
@using Dikubot.DataLayer.Database.Guild.Models.User
@using Dikubot.DataLayer.Logic.Email
@using Dikubot.DataLayer.Logic.Email.Emails
@using Dikubot.DataLayer.Logic.User
@using Dikubot.DataLayer.Logic.Validators
@using Dikubot.DataLayer.Permissions
@using Dikubot.DataLayer.Static
@using Dikubot.Discord
@using Dikubot.Webapp.Authentication
@using Dikubot.Webapp.Pages
@using SendGrid.Helpers.Mail

@inject AuthenticationStateProvider AuthenticationStateProvider
@inject IJSRuntime JsRuntime


@if (String.IsNullOrEmpty(secretPassword))
{
    <MudCard>
        <MudCardHeader>
            @if (incorrectPassword)
            {
                <MudAlert Severity="Severity.Error">
                    <Localization>
                        <Danish>Koden du indtastede er desværre ikke korrekt, du bedes derfor indtaste din email igen.</Danish>
                        <English> Unfortunately, the code you entered is not correct, so please enter your email again. </English>
                    </Localization>
                </MudAlert>
            }
            @if (emailTaken)
            {
                <MudAlert Severity="Severity.Error">
                    <Localization>
                        <Danish>Emailen @(email) er allerede i brug. Log ind på din anden Discord profil eller kontakt en administrator: <MudField> Support@kuliv.dk </MudField>.</Danish>
                        <English>The email @(email) is already in use. Log in to your other Discord profile or contact an administrator: <MudField> Support@kuliv.dk </MudField>.</English>
                        </Localization>
                    
                </MudAlert>
            }
            <MudText Typo="Typo.h6">
                <Localization>
                    <Danish>
                        Bekræft din KU-mail
                    </Danish>
                    <English>
                        Confirm your KU email
                    </English>
                </Localization>
            </MudText>
        </MudCardHeader>
        <MudCardContent>
            <MudForm>
                <MudTextField 
                    @bind-Value="email"
                    Validation="@_kuEmailValidation.Validation"
                    Immediate="@true"
                    AutoFocus="@true"
                    HelperText="Vi skal bruge din email, for at bekræfte du går på KU"
                    Label="KU Email"
                    OnKeyDown="@EmailOnEnter">
                </MudTextField>
            </MudForm>
        </MudCardContent>
        <MudCardActions>
            <MudButton OnClick="@SendEmail">Send email</MudButton>
            <MudButton Link="Logout" Color="Color.Error">Logud</MudButton>
        </MudCardActions>
    </MudCard>   
}
else
{
    <MudCard>
        <MudCardHeader>
            <MudText Typo="Typo.h5">
                <Localization>
                    <Danish>Vi har sendt en kode til din email: @(email)</Danish>
                    <English>We have sent a code to your email: @(email)</English>
                </Localization>
            </MudText>
        </MudCardHeader>
        <MudCardContent>
            <MudText Typo="Typo.body1">
                <Localization>
                    <Danish>
                        Hvis du ikke har modtaget en email inden for 2 min, så tjek om den er endt som spam her: <MudLink Href="https://security.microsoft.com/quarantine" Target="_blank">https://security.microsoft.com/quarantine</MudLink>.
                        Hvis du stadig ikke har modtaget en email med en kode, så skriv en mail fra din KU mail til <MudField> Support@kuliv.dk </MudField>.
                    </Danish>
                    <English>
                        If you have not received an email within 2 minutes, check whether it has ended up as spam here: <MudLink Href="https://security.microsoft.com/quarantine" Target="_blank">https://security.microsoft.com/quarantine</MudLink>.
                        If you still haven't received an email with a code, write an email from your KU email to <MudField> Support@kuliv.dk </MudField>.
                    </English>
                </Localization>
            </MudText>
            <MudForm>
                <MudTextField
                    @bind-Value="passwordInput"
                    Validation="@_kuEmailValidation"
                    Immediate="@true"
                    AutoFocus="@true"
                    HelperText="Du kan finde koden i din email"
                    Label="Indtast koden her"
                    OnKeyDown="@PasswordOnEnter">
                </MudTextField>
            </MudForm>
        </MudCardContent>
        <MudCardActions>
            <MudButton OnClick="@ConfirmEmailPassword">Bekræft kode</MudButton>
        </MudCardActions>
    </MudCard>
}


@code {
     [Parameter]
    public Login parent { get; set; }


    private KUEmailValidation _kuEmailValidation = new KUEmailValidation();
    private Authenticator authenticator;
    private UserIdentity user;
    private string email = "";
    private string secretPassword = "";
    private string passwordInput = "";
    bool incorrectPassword = false;
    bool emailTaken = false;

    public void EmailOnEnter(KeyboardEventArgs e)
    {
        if (e.Code == "Enter")
        {
            SendEmail();
        }
    }
    
    public void PasswordOnEnter(KeyboardEventArgs e)
    {
        if (e.Code == "Enter")
        {
            ConfirmEmailPassword();
        }
    }
    
    protected override async Task OnInitializedAsync()
    {
        authenticator = ((Authenticator) AuthenticationStateProvider);
        var authState = await authenticator.GetAuthenticationStateAsync();
        user = (UserIdentity) authState.User.Identity;
    }
    
    private async void SendEmail()
    {
        if (!(await _kuEmailValidation.ValidateAsync(email)).IsValid)
        {
            return;
        }

        secretPassword = Util.SimpleRandomStringNumbers(6);
        Console.WriteLine(secretPassword);
        VerificationEmail verification = new VerificationEmail(new EmailAddress(email), secretPassword);
        await EmailService.SendEmail(verification);
        await InvokeAsync(() => { StateHasChanged(); });
    }

    private async void ConfirmEmailPassword()
    {
        if (string.IsNullOrEmpty(secretPassword) || !secretPassword.Equals(passwordInput))
        {
            passwordInput = "";
            email = "";
            incorrectPassword = true;
            secretPassword = "";
            await InvokeAsync(() => { StateHasChanged(); });
            return;
        }
        
        UserGlobalServices userGlobalServices = new UserGlobalServices();
        
        // If the user already exists, throw an error at them!
        if (userGlobalServices.EmailExists(email))
        {
            emailTaken = true;
            passwordInput = "";
            email = "";
            secretPassword = "";
            await InvokeAsync(() => { StateHasChanged(); });
            return;
        }
        
        // null if user or no mutual guilds can be found.
        IReadOnlyCollection<SocketGuild> mutualGuilds = DiscordBot.ClientStatic.GetUser(user.UserGlobalModel.DiscordIdLong)?.MutualGuilds;

        user.UserGlobalModel.Email = email;
        user.UserGlobalModel.Verified = true;
        userGlobalServices.Upsert(user.UserGlobalModel);
        if (mutualGuilds != null)
            foreach (SocketGuild mutualGuild in mutualGuilds)
            {
                UpdateUserInGuild(mutualGuild, userGlobalServices);
            }
        await authenticator.UpdateSession();
        parent.Update();
    }
    private async void UpdateUserInGuild(SocketGuild guild, UserGlobalServices userGlobalServices)
    {
        UserGuildServices userGuildServices = new UserGuildServices(guild);
        PermissionsService permissionsService = new PermissionsService(guild);
        UserGuildModel newUser = userGuildServices.Get(user.UserGlobalModel.DiscordId);

        await permissionsService.SetDiscordUserRoles(newUser);
        
        string name = new KUUser(email.Split("@")[0]).GetName();
        if (name != "")
        {
            newUser.Name = name;
            try
            {
                await guild.GetUser(Convert.ToUInt64(user.UserGlobalModel.DiscordId)).ModifyAsync(guildUser =>
                {
                    guildUser.Nickname = name;
                });
            }
            catch (Exception e)
            {
    //ignored
            }
        }
        userGuildServices.Upsert(newUser);
    }
}