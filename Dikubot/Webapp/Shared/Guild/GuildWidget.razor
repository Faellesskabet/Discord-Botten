@using Dikubot.DataLayer.Database.Global.GuildSettings
@using Dikubot.DataLayer.Database.Global.Session
@using Dikubot.DataLayer.Database.Global.User
@using Dikubot.DataLayer.Static
@using Dikubot.Discord
@using Dikubot.Webapp.Authentication
@using Microsoft.IdentityModel.Tokens
@inject AuthenticationStateProvider AuthenticationStateProvider
@inject NavigationManager NavigationManager

<MudCard Elevation="25">
    <MudCardHeader>
        <CardHeaderAvatar>
            <MudAvatar Image="@Guild.LogoUrl"></MudAvatar>
        </CardHeaderAvatar>
        <CardHeaderContent>
            <MudText Typo="Typo.body1">@Guild.Name</MudText>
            <MudText Typo="Typo.body2">@DiscordBot.Client.GetGuild(Guild.GuildId).MemberCount Medlemmere</MudText>
        </CardHeaderContent>
        <CardHeaderActions>
            @if (EnableJoin)
            {
                <MudButton Color="Color.Success" Variant="Variant.Filled" OnClick="@JoinGuild">Join fællesskab</MudButton>
            }
            else
            {
                <MudButton Color="Color.Primary" Variant="Variant.Filled" OnClick="@GotoGuild">Gå til side</MudButton>
            }
                    
        </CardHeaderActions>
    </MudCardHeader>
    @if (!@Guild.BannerUrl.IsNullOrEmpty())
    {
        <MudCardMedia Image="@Guild.BannerUrl" Height="250" />
    }
    <MudCardContent Style="max-height: 200px; overflow: scroll;">
        <MudText>@Guild.Description</MudText>
    </MudCardContent>
    <MudCardActions>
    </MudCardActions>
</MudCard>

@code {
    [Inject] private IDialogService DialogService { get; set; }
    [Parameter] public GuildSettingsModel Guild { get; set; }
    [Parameter] public bool EnableJoin { get; set; }

    private async Task GotoGuild()
    {
        var authenticator = ((Authenticator) AuthenticationStateProvider);
        var authState = await authenticator.GetAuthenticationStateAsync();
        UserIdentity user = (UserIdentity) authState.User.Identity;
        UserGlobalModel userModel = user?.UserGlobalModel;

        if (userModel == null)
        {
            await DialogService.ShowMessageBox( "Fejl ???", "Der er sket en fejl. Prøv at clear dine cookies og refresh");
            return;
        }

        userModel.SelectedGuild = Guild.GuildId;
        new UserGlobalServices().Upsert(user.UserGlobalModel);
        SessionModel sessionModel = new SessionModel(user.UserGlobalModel);
        await authenticator.UpdateSession(sessionModel);
        NavigationManager.NavigateTo("/");
        
    }
    
    private async Task JoinGuild()
    {
        UserGlobalModel userModel = await ((Authenticator) AuthenticationStateProvider).GetUserGlobal();
        if (userModel == null)
        {
            await DialogService.ShowMessageBox( "Fejl ???", "Der er sket en fejl. Prøv at clear dine cookies og refresh");
            return;
        }
        
        SessionServices sessionServices = new SessionServices();
        SessionModel sessionModel = sessionServices.Get(model => model.UserId == userModel.Id);
        if (sessionModel == null)
        {
            await DialogService.ShowMessageBox( "Fejl ???", "Der er sket en fejl. Prøv at clear dine cookies og refresh");
            return;
        }

        bool? result = await DialogService.ShowMessageBox(
            "Bekræft", 
            "Du er ved at join et nyt fællesskab. Er du sikker?", 
            yesText:"Join", cancelText:"Fortryd");

        if (!result.GetValueOrDefault())
        {
            return;
        }

        try
        {
            await DiscordBot.Client.GetGuild(Guild.GuildId).AddGuildUserAsync(userModel.DiscordIdLong, sessionModel.DiscordAuthenticationModel.AccessToken);
        }
        catch (Exception e)
        {
            await DialogService.ShowMessageBox( "Fejl ???", "Der er sket en fejl. Prøv at clear dine cookies og refresh");
            return;
        }
        await GotoGuild();
    }
}