@inherits LayoutComponentBase
@using Dikubot.Webapp.Authentication
@using Dikubot.Webapp.Authentication
@using Dikubot.Discord
@using global::Discord.WebSocket
@using Dikubot.DataLayer.Database.Global.GuildSettings
@using MudBlazor.Utilities
@using Dikubot.Webapp.Extensions.NavMenu
@inject AuthenticationStateProvider AuthenticationStateProvider
@inject NavigationManager _navigationManager;
@inject UserService _user
@inject NotifyStateService _notifyStateService
<MudLayout>
    <MudAppBar Elevation="1" Color="Color.Primary">
        <MudIconButton Icon="@Icons.Material.Filled.Menu" Color="Color.Inherit" Edge="Edge.Start" OnClick="@ToggleDrawer" />
        @if (_loaded)
        {
            <MudText Typo="Typo.h5">
                <Localization>
                    <Danish>
                        @_guildSettingsModel.Name fællesskabet
                    </Danish>
                    <English>
                         @_guildSettingsModel.Name community
                    </English>
                </Localization>
               
            </MudText>
        }
        <MudSpacer />
            <Localization>
                <Danish>
                    <MudButton OnClick="() => new ChangeLocalization(_user, _notifyStateService).Change(ChangeLocalization.Language.English)">
                                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 36 36"><path fill="#C60C30" d="M32 5H15v11h21V9c0-2.209-1.791-4-4-4zM15 31h17c2.209 0 4-1.791 4-4.5V20H15v11zM0 20v6.5C0 29.209 1.791 31 4 31h7V20H0zM11 5H4C1.791 5 0 6.791 0 9v7h11V5z"/><path fill="#EEE" d="M15 5h-4v11H0v4h11v11h4V20h21v-4H15z"/></svg>
                    </MudButton>
                </Danish>
                <English>
                    <MudButton OnClick="() => new ChangeLocalization(_user, _notifyStateService).Change(ChangeLocalization.Language.Danish)" >
                        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 36 36"><path fill="#00247D" d="M0 9.059V13h5.628zM4.664 31H13v-5.837zM23 25.164V31h8.335zM0 23v3.941L5.63 23zM31.337 5H23v5.837zM36 26.942V23h-5.631zM36 13V9.059L30.371 13zM13 5H4.664L13 10.837z"/><path fill="#CF1B2B" d="M25.14 23l9.712 6.801c.471-.479.808-1.082.99-1.749L28.627 23H25.14zM13 23h-2.141l-9.711 6.8c.521.53 1.189.909 1.938 1.085L13 23.943V23zm10-10h2.141l9.711-6.8c-.521-.53-1.188-.909-1.937-1.085L23 12.057V13zm-12.141 0L1.148 6.2C.677 6.68.34 7.282.157 7.949L7.372 13h3.487z"/><path fill="#EEE" d="M36 21H21v10h2v-5.836L31.335 31H32c1.117 0 2.126-.461 2.852-1.199L25.14 23h3.487l7.215 5.052c.093-.337.158-.686.158-1.052v-.058L30.369 23H36v-2zM0 21v2h5.63L0 26.941V27c0 1.091.439 2.078 1.148 2.8l9.711-6.8H13v.943l-9.914 6.941c.294.07.598.116.914.116h.664L13 25.163V31h2V21H0zM36 9c0-1.091-.439-2.078-1.148-2.8L25.141 13H23v-.943l9.915-6.942C32.62 5.046 32.316 5 32 5h-.663L23 10.837V5h-2v10h15v-2h-5.629L36 9.059V9zM13 5v5.837L4.664 5H4c-1.118 0-2.126.461-2.852 1.2l9.711 6.8H7.372L.157 7.949C.065 8.286 0 8.634 0 9v.059L5.628 13H0v2h15V5h-2z"/><path fill="#CF1B2B" d="M21 15V5h-6v10H0v6h15v10h6V21h15v-6z"/></svg>
                    </MudButton>
                </English>
            </Localization>
        
        <MudIconButton Icon="@Icons.Custom.Brands.GitHub" Color="Color.Inherit" Link="https://github.com/Faellesskabet/Discord-Botten" Target="_blank" />
    </MudAppBar>
    <MudDrawer @bind-Open="@open" Elevation="1" Style="@($"background-color: {NavColor}; color: {NavTextColor};")">
        <MudDrawerHeader>
            @if (_loaded)
            {
                <MudAvatar Image="@_guildSettingsModel.LogoUrl" Size="Size.Large"></MudAvatar>
            }
        </MudDrawerHeader>
        <MudNavMenu> 
            <SideNavMenu User="@user"> </SideNavMenu>
        </MudNavMenu>
    </MudDrawer>
    <MudMainContent Class="pt-16">
        <MudBreadcrumbs Items="_breadcrumbItems" MaxItems="6" Style="height: 0px;">
            <ItemTemplate Context="item">
                <MudLink Href="@item.Href" Color="Color.Primary">@item.Text</MudLink>
            </ItemTemplate>
            
        </MudBreadcrumbs>
        <MudContainer Class="mt-6" Style="min-height: 100vh">
            @Body
        </MudContainer>
    </MudMainContent>
    <Footer style="margin-top: 15px;"></Footer>
</MudLayout>

@code{
    bool open = true;
    private Authenticator authenticator;
    private UserIdentity user;
    private SocketGuild guild;
    private GuildSettingsModel _guildSettingsModel;
    private bool _loaded = false;
    private string NavColor = "";
    private string NavTextColor = "";
    
    private List<BreadcrumbItem> _breadcrumbItems = new List<BreadcrumbItem>();

    protected override void OnParametersSet()
    {
        var thisUri = _navigationManager.ToBaseRelativePath(_navigationManager.Uri).Split("/");

        string href = "";
        _breadcrumbItems = new List<BreadcrumbItem>
        {
            new BreadcrumbItem("Home", href: "")
        };
        foreach (string uri in thisUri)
        {   
            href += "/" + uri;
            _breadcrumbItems.Add(new BreadcrumbItem(string.IsNullOrWhiteSpace(uri) ? "" : string.Concat(uri[0].ToString().ToUpper(), uri.AsSpan(1)),href,thisUri.Last().Equals(uri)));
        }
        base.OnParametersSet();
    }
    

    protected override async Task OnInitializedAsync()
    {
        NavColor = GetColor().Value;
        NavTextColor = GetTextColor().Value;
        await SetData();
        _loaded = true;
        _notifyStateService.UserChange += UserChange;

    }

    private async Task SetData()
    {
        authenticator = ((Authenticator) AuthenticationStateProvider);
        var authState = await authenticator.GetAuthenticationStateAsync();
        user = (UserIdentity) authState.User.Identity;
        if (user == null)
        {
            return;
        }
        guild = DiscordBot.ClientStatic.GetGuild(user.UserGlobalModel.SelectedGuild);
        _guildSettingsModel = new GuildSettingsService().Get(model => model.GuildId == user.UserGlobalModel.SelectedGuild) ?? new GuildSettingsModel(guild);
    }
    
    private void UserChange(object? sender, EventArgs e)
    {
        SetData();
        StateHasChanged();
    }
    
    void ToggleDrawer()
    {
        open = !open;
    }

    private MudColor GetColor()
    {
        return App.ThemeProvider.IsDarkMode ? App.ThemeProvider.Theme.PaletteDark.Background : App.ThemeProvider.Theme.Palette.Background;
    }

    private MudColor GetTextColor()
    {
        return App.ThemeProvider.IsDarkMode ? App.ThemeProvider.Theme.PaletteDark.TextPrimary : App.ThemeProvider.Theme.Palette.TextPrimary;
    }
    
}

